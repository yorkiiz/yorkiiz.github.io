#### 持久化

##### RDB默认的redis database

1.自动触发

  a.规则

  b.shutdown触发

  c.flushall触发的rdb文件空的



2.手动触发

save 阻塞其他的指令

bgsave 后台异步



rbd优势劣势

1.rdb比aof性能高，快

2.丢失数据



##### AOF

默认关闭

config文件 appendonly on

开启后，就是RDB跟AOF同时备份，恢复时默认用aof

bgrewriteaof重写机制

重写触发机制

auto-aof-rewrite-percentage 100

auto-aof-rewrite-min-size 64 mb



aof性能没有rdb高，安全性比rdb好



#### 主从同步

salveof 192.168.1.1 6379

发生主从切换的时候，这个配置就会改写成

replicaof 192.168.1.1 6379



连接阶段

1.启动，拿到master和host端口

2.slave有1个定时任务，replicationcron

二.数据同步

3.第一次需要全量复制

三.命令传播阶段

4.master所有的心的指令放到我们的内存,slave client buffer,从结点记载玩rdb后，会从我们的这个内存中拿到数据（增量）





#### 哨兵

自动帮我恢复

优先级，偏移量，进程id



#### 脑裂

表示网络异常导致有2个主节点

必须要有几个从结点



#### cluster

redis 3.0 自带

算法

怎么样去让key 分不到不同的节点

范围1-10000 节点1 10001-20000节点2 

hash取模数量不足



虚拟槽

16384个槽slot，真是节点槽

0  0-3000

1  3000-6000

2  6000-16384



#### 场景分析

分布式锁

锁，从变成主，挂了

看门狗

zk必须同步主节点数据，不会有问题



红锁 redlock

多台master去加锁，如果有3台，那必须2台才能通过



为什么用hset

里面有个threadld 重复锁



数据一致性

缓存穿透，击穿，雪崩

数据失效，请求redis和db都没有







